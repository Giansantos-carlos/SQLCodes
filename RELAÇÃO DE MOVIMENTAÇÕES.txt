SELECT DISTINCT
ITE.NUNOTA,
Ite.CODEMP,
ITE.AD_ORIGEM,
CAB.DTMOV,
OPC.OPCAO,
CAB.CODTIPOPER,
ITE.CODPROD,
PRO.DESCRPROD,
ITE.QTDNEG,
LOC.DESCRLOCAL AS ORIG,
LOC2.DESCRLOCAL AS DEST,
OPC2.OPCAO AS ORIGEM
FROM TGFITE ITE
JOIN TGFITE ITE2 ON ITE.NUNOTA = ITE2.NUNOTA AND ITE.CODPROD = ITE2.CODPROD AND ITE2.SEQUENCIA < 0
AND ITE.SEQUENCIA = (ITE2.SEQUENCIA * -1)
JOIN TGFPRO PRO ON PRO.CODPROD = ITE.CODPROD
JOIN TGFCAB CAB ON CAB.NUNOTA = ITE.NUNOTA
JOIN TGFLOC LOC ON CODLOCAL = ITE.CODLOCALORIG
JOIN TGFLOC LOC2 ON LOC2.CODLOCAL = ITE2.CODLOCALORIG
LEFT JOIN TDDOPC OPC ON OPC.VALOR = CAB.AD_MOTIVO2 AND OPC.NUCAMPO = 9999990272
LEFT JOIN TDDOPC OPC2 ON OPC.VALOR = ITE.AD_ORIGEM AND OPC.NUCAMPO = 9999990273
WHERE  CAB.TIPMOV = 'T'
AND ITE.CODLOCALORIG <> ITE2.CODLOCALORIG
AND CAB.CODTIPOPER IN (1403,1400)
AND CAB.DTMOV BETWEEN :PERIODO.INI AND :PERIODO.FIN
AND (ITE.CODPROD = :CODPROD OR :CODPROD is NULL)
AND ((ITE.CODEMP = :CODEMP) OR (:CODEMP IS NULL))
AND CAB.TIPMOV = 'T'


