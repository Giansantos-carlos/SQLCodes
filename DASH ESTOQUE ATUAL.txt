SELECT ISNULL((CASE (SELECT INTEIRO FROM TSIPAR WHERE CHAVE='CODPROREF') 
		  WHEN 0 THEN CHAR(EST.CODPROD)
		  WHEN 1 THEN ISNULL(PRO.REFERENCIA,CHAR(EST.CODPROD))
       END),PRO.CODPROD) AS COD_PRODUTO
      ,PRO.DESCRPROD 
      ,PRO.CODVOL
      ,ISNULL(EST.ESTOQUE,0) AS ESTOQUE
      ,EXC.VLRVENDA AS VALOR 
      ,ISNULL(EST.RESERVADO,0) AS RESERVADO
      ,ISNULL(EST.ESTOQUE,0)-ISNULL(EST.RESERVADO,0) AS ESTOQUE_DISPONIVEL
      ,PRO.PESOLIQ
      ,PRO.PESOLIQ * (ISNULL(EST.ESTOQUE,0)-ISNULL(EST.RESERVADO,0)) AS PESO_LIQ_DISPONIVEL
      ,PRO.ESTMIN
      ,PRO.LEADTIME
      ,EST.CODLOCAL
      ,LOC.DESCRLOCAL
      ,EST.CODEMP
      ,EMP.NOMEFANTASIA
      ,GRU.CODGRUPOPROD
      ,GRU.DESCRGRUPOPROD
	  ,CASE EST.TIPO WHEN 'P' THEN 'Próprio' END AS Tipo      
	  ,CASE EST.CODPARC WHEN '0' THEN 'Próprio' ELSE 'Terceiro - '+PAR.NOMEPARC END AS Poder        
FROM TGFPRO PRO
    LEFT JOIN TGFEST EST ON (PRO.CODPROD = EST.CODPROD)
    LEFT JOIN TSIEMP EMP ON (EST.CODEMP = EMP.CODEMP)
    JOIN TGFGRU GRU ON (GRU.CODGRUPOPROD = PRO.CODGRUPOPROD)
    LEFT JOIN TGFLOC LOC ON (EST.CODLOCAL = LOC.CODLOCAL)
    LEFT JOIN TGFPAR PAR ON (EST.CODPARC = PAR.CODPARC)
    INNER JOIN TGFEXC EXC ON (EXC.CODPROD = PRO.CODPROD)
WHERE PRO.USOPROD IN ('R','D','V')
     AND PRO.CODPROD <> 0
	 AND (EST.CODPROD = :P_CODPROD OR :P_CODPROD IS NULL)
 	 AND (EST.CODLOCAL = :P_CODLOCAL OR :P_CODLOCAL IS NULL)
     AND (PRO.CODGRUPOPROD = :P_CODGRUPOPROD OR :P_CODGRUPOPROD IS NULL)
     AND (EST.CODEMP = :P_CODEMP OR :P_CODEMP IS NULL OR EST.CODEMP IS NULL)
     AND (NUTAB = 4)
ORDER BY 1