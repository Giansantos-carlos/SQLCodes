	  WITH CNPJ AS
(SELECT COUNT(DISTINCT CAB.CODPARC) AS CNPJ
FROM
	TGFITE ITE 
	INNER JOIN TGFCAB CAB ON (ITE.NUNOTA = CAB.NUNOTA)
	INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
	INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
WHERE   ((CAB.PENDENTE = 'S' AND CAB.CODTIPOPER IN(3100,3102,3103,3105,3107,3108)) OR CAB.CODTIPOPER IN (3208,3217,3214,3224,3210,3213,30,3200,3212,3216,3219))
		AND CAB.DTMOV >= :P_PERIODO.INI AND CAB.DTMOV <=:P_PERIODO.FIN
		AND ((SELECT UFS.UF FROM TSIUFS UFS INNER JOIN TSICID CID ON UFS.CODUF=CID.UF INNER JOIN TGFPAR PAR ON CID.CODCID = PAR.CODCID WHERE PAR.CODPARC = CAB.CODPARC) IN :P_UF)
		AND CAB.CODVEND IN :P_VEND
		AND PRO.CODGRUPOPROD IN :P_GRUPO
		AND (ITE.CODPROD = :P_PRODUTO OR :P_PRODUTO IS NULL)
		AND LEFT(PRO.CODGRUPOPROD,6) IN :P_FAMILIA
		AND (CAB.CODEMP = :P_CODEMP OR :P_CODEMP IS NULL)
),

		PRE AS 
(SELECT
	ITE.CODPROD AS CODPROD,
	PRO.DESCRPROD AS PRODUTO,
	SUM(ITE.QTDNEG) AS QUANTIDADE,
	SUM(CASE WHEN SUBSTRING(NTA.NOMETAB, 2, 1) = 'X'
        THEN (ITE.VLRTOT - ITE.VLRDESC) * 2
      ELSE ITE.VLRTOT - ITE.VLRDESC END) AS VALOR,
	COUNT(DISTINCT CAB.CODPARC) AS CNPJ,
	SUM(ITE.VLRTOT)/COUNT(DISTINCT CAB.CODPARC) AS MEDIACNPJ
FROM
	TGFITE ITE 
	INNER JOIN TGFCAB CAB ON (ITE.NUNOTA = CAB.NUNOTA)
	INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
	INNER JOIN TGFTAB TAB ON (ITE.NUTAB = TAB.NUTAB)
	INNER JOIN TGFNTA NTA ON (TAB.CODTAB = NTA.CODTAB)
	INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
	INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
	INNER JOIN TSICID CID ON (PAR.CODCID = CID.CODCID)
	INNER JOIN TSIUFS UFS ON (UFS.CODUF = CID.UF)
WHERE CAB.PENDENTE = 'S' 
		AND CAB.CODTIPOPER IN(3100,3102)
		AND CAB.DTMOV >= :P_PERIODO.INI AND CAB.DTMOV <=:P_PERIODO.FIN
		AND UFS.UF IN :P_UF
		AND CAB.CODVEND IN :P_VEND
		AND PRO.CODGRUPOPROD IN :P_GRUPO
		AND (ITE.CODPROD = :P_PRODUTO OR :P_PRODUTO IS NULL)
		AND LEFT(PRO.CODGRUPOPROD,6) IN :P_FAMILIA
		AND (CAB.CODEMP = :P_CODEMP OR :P_CODEMP IS NULL)
       AND (PRO.CODPARCFORN = :P_CODPARCFORN OR :P_CODPARCFORN IS NULL)
       AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
GROUP BY
	ITE.CODPROD,
	PRO.DESCRPROD
),

PED AS 
(SELECT
	ITE.CODPROD AS CODPROD,
	PRO.DESCRPROD AS PRODUTO,
	SUM(ITE.QTDNEG) AS QUANTIDADE,
	SUM(CASE WHEN SUBSTRING(NTA.NOMETAB, 2, 1) = 'X'
        THEN (ITE.VLRTOT - ITE.VLRDESC) * 2
      ELSE ITE.VLRTOT - ITE.VLRDESC END) AS VALOR,
	COUNT(DISTINCT CAB.CODPARC) AS CNPJ,
	SUM(ITE.VLRTOT)/COUNT(DISTINCT CAB.CODPARC) AS MEDIACNPJ
FROM
	TGFITE ITE 
	INNER JOIN TGFCAB CAB ON (ITE.NUNOTA = CAB.NUNOTA)
	INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
	INNER JOIN TGFTAB TAB ON (ITE.NUTAB = TAB.NUTAB)
	INNER JOIN TGFNTA NTA ON (TAB.CODTAB = NTA.CODTAB)
	INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
	INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
	INNER JOIN TSICID CID ON (PAR.CODCID = CID.CODCID)
	INNER JOIN TSIUFS UFS ON (UFS.CODUF = CID.UF)
WHERE CAB.PENDENTE = 'S' 
		AND CAB.CODTIPOPER IN(3103,3105,3107,3108)
		AND CAB.DTMOV >= :P_PERIODO.INI AND CAB.DTMOV <=:P_PERIODO.FIN
		AND UFS.UF IN :P_UF
		AND CAB.CODVEND IN :P_VEND
		AND PRO.CODGRUPOPROD IN :P_GRUPO
		AND (ITE.CODPROD = :P_PRODUTO OR :P_PRODUTO IS NULL)
		AND LEFT(PRO.CODGRUPOPROD,6) IN :P_FAMILIA
		AND (CAB.CODEMP = :P_CODEMP OR :P_CODEMP IS NULL)
       AND (PRO.CODPARCFORN = :P_CODPARCFORN OR :P_CODPARCFORN IS NULL)
       AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
GROUP BY
	ITE.CODPROD,
	PRO.DESCRPROD
),

NOTA AS 
(SELECT
	ITE.CODPROD AS CODPROD,
	PRO.DESCRPROD AS PRODUTO,
	SUM(ITE.QTDNEG) AS QUANTIDADE,
	SUM(CASE WHEN SUBSTRING(NTA.NOMETAB, 2, 1) = 'X'
        THEN (ITE.VLRTOT - ITE.VLRDESC) * 2
      ELSE ITE.VLRTOT - ITE.VLRDESC END) AS VALOR,
	COUNT(DISTINCT CAB.CODPARC) AS CNPJ,
	SUM(ITE.VLRTOT)/COUNT(DISTINCT CAB.CODPARC) AS MEDIACNPJ
FROM
	TGFITE ITE 
	INNER JOIN TGFCAB CAB ON (ITE.NUNOTA = CAB.NUNOTA)
	INNER JOIN TGFVEN VEN ON (CAB.CODVEND = VEN.CODVEND)
	INNER JOIN TGFTAB TAB ON (ITE.NUTAB = TAB.NUTAB)
	INNER JOIN TGFNTA NTA ON (TAB.CODTAB = NTA.CODTAB)
	INNER JOIN TGFPRO PRO ON (ITE.CODPROD = PRO.CODPROD)
	INNER JOIN TGFPAR PAR ON (CAB.CODPARC = PAR.CODPARC)
	INNER JOIN TSICID CID ON (PAR.CODCID = CID.CODCID)
	INNER JOIN TSIUFS UFS ON (UFS.CODUF = CID.UF)
WHERE   CAB.CODTIPOPER IN(3208,3217,3214,3224,3210,3213,30,3200,3212,3216,3219)
		AND CAB.DTMOV >= :P_PERIODO.INI AND CAB.DTMOV <=:P_PERIODO.FIN
		AND UFS.UF IN :P_UF
		AND CAB.CODVEND IN :P_VEND
		AND PRO.CODGRUPOPROD IN :P_GRUPO
		AND (ITE.CODPROD = :P_PRODUTO OR :P_PRODUTO IS NULL)
		AND LEFT(PRO.CODGRUPOPROD,6) IN :P_FAMILIA
		AND (CAB.CODEMP = :P_CODEMP OR :P_CODEMP IS NULL)
       AND (PRO.CODPARCFORN = :P_CODPARCFORN OR :P_CODPARCFORN IS NULL)
       AND (PAR.CODPARC = :P_CODPARC OR :P_CODPARC IS NULL)
GROUP BY
	ITE.CODPROD,
	PRO.DESCRPROD
)


SELECT
	ISNULL(PRE.CODPROD,ISNULL(PED.CODPROD,NOTA.CODPROD)) AS CODPROD, 
	ISNULL(PRE.PRODUTO,ISNULL(PED.PRODUTO,NOTA.PRODUTO)) AS PRODUTO,
	SUM(ISNULL(PRE.QUANTIDADE,0))+SUM(ISNULL(PED.QUANTIDADE,0))+SUM(ISNULL(NOTA.QUANTIDADE,0)) AS QUANTIDADE,
	SUM(ISNULL(PRE.VALOR,0))+SUM(ISNULL(PED.VALOR,0))+SUM(ISNULL(NOTA.VALOR,0)) AS VALOR,
	SUM(ISNULL(PRE.CNPJ,0))+SUM(ISNULL(PED.CNPJ,0))+SUM(ISNULL(NOTA.CNPJ,0)) AS CNPJ_ATENDIDO,
	SUM(ISNULL(PRE.QUANTIDADE,0)) AS PRE,
	SUM(ISNULL(PED.QUANTIDADE,0)) AS PED,
	SUM(ISNULL(NOTA.QUANTIDADE,0)) AS NOTA,
	(SUM(ISNULL(PRE.VALOR,0))+SUM(ISNULL(PED.VALOR,0))+SUM(ISNULL(NOTA.VALOR,0)))/(SUM(ISNULL(PRE.CNPJ,0))+SUM(ISNULL(PED.CNPJ,0))+SUM(ISNULL(NOTA.CNPJ,0))) AS MEDIACNPJ,
	MAX(CNPJ.CNPJ) AS CNPJTOTAL
FROM
	PRE FULL OUTER JOIN PED ON (PRE.CODPROD = PED.CODPROD) FULL OUTER JOIN NOTA ON (PED.CODPROD = NOTA.CODPROD), CNPJ
GROUP BY
		ISNULL(PRE.CODPROD,ISNULL(PED.CODPROD,NOTA.CODPROD)),
		ISNULL(PRE.PRODUTO,ISNULL(PED.PRODUTO,NOTA.PRODUTO))