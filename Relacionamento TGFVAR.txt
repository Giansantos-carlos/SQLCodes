SELECT DISTINCT NUNOTA AS PrePedido, DTMOV,

    -- Numero unico de pedido de venda--
		REPLACE(SUBSTRING((
          SELECT DISTINCT ', ' + CAST(VAR.NUNOTA AS VARCHAR(10))
          FROM TGFVAR VAR
          WHERE (SELECT TIPMOV FROM TGFCAB WHERE NUNOTA = VAR.NUNOTA) = 'P' AND VAR.NUNOTAORIG = CAB.NUNOTA
          FOR XML PATH ('')
        ), 2, 1000),'  ','') Pedido,
        -- NFe de vendas e raro mas pode haver mais de uma geralmente denegadas --
        REPLACE(SUBSTRING((
          SELECT DISTINCT ', ' + CAST(VAR.NUNOTA AS VARCHAR(10))
          FROM TGFVAR VAR
          WHERE (SELECT TIPMOV FROM TGFCAB WHERE NUNOTA = VAR.NUNOTA) = 'V' AND (VAR.NUNOTAORIG IN
			  (SELECT DISTINCT VAR.NUNOTA
			  FROM TGFVAR VAR
			  WHERE VAR.NUNOTAORIG = CAB.NUNOTA AND TIPMOV = 'P') OR (VAR.NUNOTAORIG = CAB.NUNOTA AND CAB.TIPMOV = 'P'))
          FOR XML PATH ('')
        ), 2, 1000),'  ','') Venda,
        -- NFe adicional --
        REPLACE(SUBSTRING((
              SELECT DISTINCT ', ' + CAST(VAR.NUNOTA AS VARCHAR(10))
              FROM TGFVAR VAR
              WHERE (SELECT TIPMOV FROM TGFCAB WHERE NUNOTA = VAR.NUNOTA) = 'V' AND VAR.NUNOTAORIG IN
    			  (SELECT DISTINCT VAR.NUNOTA
    			  FROM TGFVAR VAR
    			  WHERE VAR.NUNOTAORIG IN
    				  (SELECT DISTINCT VAR.NUNOTA
    				  FROM TGFVAR VAR
    				  WHERE VAR.NUNOTAORIG = CAB.NUNOTA AND TIPMOV = 'P'))
    			  FOR XML PATH ('')
			), 2, 1000),'  ','') Adicional,
			
			-- NFe devolucao --
			REPLACE(SUBSTRING((
          SELECT DISTINCT ', ' + CAST(VAR.NUNOTA AS VARCHAR(10))
          FROM TGFVAR VAR
          WHERE (SELECT TIPMOV FROM TGFCAB WHERE NUNOTA = VAR.NUNOTA) = 'D' AND VAR.NUNOTAORIG IN
			  (SELECT DISTINCT VAR.NUNOTA   
			  FROM TGFVAR VAR
			  WHERE VAR.NUNOTAORIG IN
				  (SELECT DISTINCT VAR.NUNOTA
				  FROM TGFVAR VAR
				  WHERE VAR.NUNOTAORIG = CAB.NUNOTA AND TIPMOV = 'P'))
			  FOR XML PATH ('')
			), 2, 1000),'  ','') DevNFe,
			-- NFe devolucao adicional --
			REPLACE(SUBSTRING((
          SELECT DISTINCT ', ' + CAST(VAR.NUNOTA AS VARCHAR(10))
          FROM TGFVAR VAR
          WHERE (SELECT TIPMOV FROM TGFCAB WHERE NUNOTA = VAR.NUNOTA) = 'D' AND VAR.NUNOTAORIG IN
			  (SELECT DISTINCT VAR.NUNOTA
			  FROM TGFVAR VAR
			  WHERE VAR.NUNOTAORIG IN
			 	 (SELECT DISTINCT VAR.NUNOTA
				  FROM TGFVAR VAR
				  WHERE VAR.NUNOTAORIG IN
					  (SELECT DISTINCT VAR.NUNOTA
					  FROM TGFVAR VAR
					  WHERE VAR.NUNOTAORIG = CAB.NUNOTA AND TIPMOV = 'P')))
				  FOR XML PATH ('')
				), 2, 1000),'  ','') DevAdicional
			
        
        FROM TGFCAB CAB WHERE (SELECT GRUPO FROM TGFTOP WHERE CODTIPOPER = CAB.CODTIPOPER AND DHALTER = CAB.DHTIPOPER) = 'PrÃ©-Venda'
AND NOT EXISTS (
	SELECT NUNOTA
	FROM TGFVAR
	WHERE TGFVAR.NUNOTA = CAB.NUNOTA AND (CAB.DTMOV >= '01/08/2021' AND CAB.DTMOV <= '04/08/2021')
	)
ORDER BY CAB.NUNOTA DESC